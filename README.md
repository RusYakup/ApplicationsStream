# Управление заявками на FastAPI

Этот проект представляет собой приложение на FastAPI, которое позволяет управлять заявками. Оно предоставляет
эндпоинты для создания новых заявок и получения списка заявок. Приложение использует базу данных для хранения данных о
заявках и Kafka для публикации сообщений при создании новой заявки. Используется консьюмер группа для горизонтального
масштабирования приложения и разделения загрузки обработки сообщений между несколькими потребителями

## Возможности

- **Создание новой заявки**: Отправка новой заявки с указанием имени пользователя и описания.
- **Получение списка заявок**: Получение списка заявок с возможностью фильтрации по имени пользователя и поддержкой
  пагинации.

## Требования

Перед началом работы убедитесь, что у вас установлено следующее:

- Python 3.12
- FastAPI
- Uvicorn (для запуска FastAPI приложения)
- Kafka (для публикации сообщений)
- База данных PostgreSQL с необходимыми таблицами.
- Alembic (для управления миграциями базы данных).

## Установка

1. **Клонируйте репозиторий**:
   ```bash
   git clone https://github.com/RusYakup/ApplicationsStream.git
   cd ApplicationsStream
   ```
2. **Установите зависимости**:
   В корневой директории проекта выполните:
   ```bash        
   pipenv install
   pipenv shell
   ```
2. **Настройте окружение**:
   Создайте файл `.env` в корневой директории и добавьте необходимые переменные окружения:
   ```plaintext
    POSTGRES_USER="POSTGRES_USER"
    POSTGRES_PASSWORD="POSTGRES_PASSWORD"
    POSTGRES_DB="POSTGRES_DB"
    LOG_LEVEL="DEBUG" # DEBUG, INFO, WARNING, ERROR
    KAFKA_BOOTSTRAP_SERVERS="kafka:9092"
    POSTGRES_HOST="postgres"
    POSTGRES_PORT="5432"
    HOST_CONSUMER = "kafka:9092"
   ```

### Запуск основного проекта

Для запуска проекта используется основной `docker-compose.yaml`:

1. **Основной `docker-compose.yaml`**:
    - Запускает основные сервисы: FastAPI, PostgreSQL, Kafka.
    - Находится в корневой директории проекта.
    - Запуск с корневой директории проекта:
      ```bash
      docker compose -f docker-compose.yaml up -d --build
     ```

### Запуск Unit-тестов.

2. **Unit-тесты `docker-compose.tests.yaml`**:

    - Запускает тесты.
    - Находится в корневой директории.
    - Запуск с корневой директории проекта:

        ```bash
          docker docker compose -f docker-compose.tests.yaml up -d --build
        
        ```

      #### Выполняются следующие тесты:
    - Создают фикстуры для очистки базы данных и менеджер базы данных.
    - Тестируют методы добавления и получения записей в базе данных.
    - Тестируются get и post запросы с использованием httpx.


#### Для полного end2end тестирования с консьюмером

3. **Консьюмер `docker-compose.consumer.yaml`**:
    - Запускает консьюмер Kafka.
    - Находится в корневой директории.
    - Запуск с корневой директории проекта:
      ```bash
        docker compose -f docker-compose.сonsumer.yaml up -d --build
      ```

## Управление миграциями с Alembic

Alembic используется для управления миграциями базы данных. Это позволяет легко изменять структуру базы данных и
применять изменения в разных окружениях.

### Создание и применение миграций

1. **Создание новой миграции**:
   После изменения моделей создайте новую миграцию:
   ```bash
   alembic revision --autogenerate -m "Описание изменений"
   ```

2. **Применение миграций**:
   Чтобы применить миграции к базе данных, выполните:
   ```bash
   alembic upgrade head
   ```

3. **Откат миграций**:
   Если нужно откатить изменения, используйте:
   ```bash
   alembic downgrade -1
   ```

## Эндпоинты API

### Создание новой заявки

- **URL**: `/applications`
- **Метод**: `POST`
- **Тело запроса**:
  ```json
  {
    "user_name": "string",
    "description": "string"
  }
  ```
- **Ответ**:
  ```json
  {
    "message": "Application created successfully"
  }
  ```

### Получение списка заявок

- **URL**: `/applications`
- **Метод**: `GET`
- **Параметры запроса**:
    - `user_name` (опционально): Фильтрация заявок по имени пользователя.
    - `page` (опционально): Номер страницы для пагинации (по умолчанию: 1).
    - `size` (опционально): Количество заявок на странице (по умолчанию: 10).
- **Ответ**:
  ```json
  {
    "applications": [
      {
        "id": "string",
        "user_name": "string",
        "description": "string",
        "created_at": "string"
      }
    ]
  }
  ```

## Логирование

Приложение использует модуль `logging` для логирования информации и ошибок. Уровень логирования можно настроить через
переменную окружения `LOG_LEVEL`.

## Интеграция с Kafka

При создании новой заявки сообщение публикуется в топик Kafka `new_applications`. Сообщение содержит детали заявки.

### Консьюмер Kafka

Консьюмер Kafka (`consumer.py`) отвечает за чтение сообщений из топика `new_applications`. Он использует библиотеку
`aiokafka` для асинхронного потребления сообщений.

#### Основные функции консьюмера:

1. **Инициализация**:
    - Консьюмер подключается к Kafka и проверяет наличие топика `new_applications`.
    - Если топик отсутствует, выводится предупреждение.

2. **Потребление сообщений**:
    - Консьюмер читает сообщения из топика и обрабатывает их с помощью метода `process_message`.
    - Каждое сообщение логируется и обрабатывается асинхронно.

3. **Обработка сообщений**:
    - Метод `process_message` принимает данные из сообщения и выполняет необходимые действия (например, сохранение в
      базу данных или отправку уведомления).

## Улучшение проекта с использованием внешнего ключа

В текущем проекте определена таблица в базе данных `application` с полями:

- `id` (автоинкрементное)
- `user_name`
- `description`
- `created_at`

На данный момент заявки не привязаны к конкретным пользователям, что затрудняет отслеживание, кто подал ту или иную
заявку.

### Предложение по улучшению:

1. **Создание таблицы `user`**  
   Мы создаем отдельную таблицу `user`, которая будет хранить информацию о пользователях. Эта таблица будет содержать
   следующие поля:

    - `id` – уникальный автоинкрементный идентификатор пользователя.
    - `user_name` – имя пользователя.
    - `email` – электронный адрес пользователя (может быть уникальным).
    - `phone` – номер телефона пользователя (если требуется).
    - `created_at` – дата и время создания записи.

2. **Добавление внешнего ключа в таблицу `application`**  
   В таблицу `application` добавляется внешний ключ `user_id`, который будет ссылаться на поле `id` в таблице `user`.
   Это позволит связывать каждую заявку с конкретным пользователем.

### Результаты:

- Каждая заявка будет однозначно ассоциирована с определенным пользователем, что обеспечит целостность данных и упростит
  отслеживание заявок.
Изменение позволит избежать дублирования информации о пользователях в разных таблицах и облегчит управление данными.м
  образом, каждая заявка будет однозначно ассоциирована с определенным пользователем, что обеспечит целостность данных и
  упростит отслеживание заявок. Кроме того, это изменение позволит избежать дублирования информации о пользователях в
  разных таблицах и облегчит управление данными.
